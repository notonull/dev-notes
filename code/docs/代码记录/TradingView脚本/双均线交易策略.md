---
title: 【TradingView】【Pine Script】双均线交易策略
copyright: CC-BY-4.0
tags:
  - trading view
  - pine script


---

## 交易原则

### 概述

名称：**双均线交易策略（专业均线交叉策略）**

类型：**趋势跟随 + 仓位管理 + 加仓策略**

数据周期：使用 `close` 价与 SMA/EMA 均线计算

支持多仓位管理（开仓、加仓、平仓、重新入场）

### 变量

1.快线 （ema20）

2.慢线 （ema60）

### 开仓信号

1.快线上传慢线并且关键K线的收盘价格突破两条均线（黄金交叉）

2.关键k线的形态必须是阳线

### 加仓信号

1.关键k线的收盘价回踩快线不跌破

2.关键k线的形态必须是阳线

### 平仓信号

1.关键k线的收盘价回踩快线跌破 或者  死叉（快线下穿慢线）

### 重入信号

1.价格回到快线之上

2.趋势向上的形态未破坏



特别容易亏钱的地方时震荡行情 和 假突破



| 场景                 | 开仓策略                                       |
| -------------------- | ---------------------------------------------- |
| 价格在交叉点已经走高 | 等价格回踩快线或慢线再开仓                     |
| 价格刚触及均线且交叉 | 可在下一根K线收盘站稳两条均线后开仓            |
| 强趋势行情           | 可适当在交叉点开仓，但需控制仓位，避免全仓追高 |
| 横盘震荡             | 避免在交叉点开仓，等待价格突破均线后确认趋势   |

问题：

* 需识别震荡行情
* 交叉点之前价格以走高



## 策略脚本

```js
//@version=5
strategy("双均线交易策略", overlay=true, margin_long=100, margin_short=100, initial_capital=100000, process_orders_on_close=true)
// === 参数输入 ===
lenSMA1 = input.int(20, title="SMA1")
lenEMA1 = input.int(20, title="EMA1")
lenSMA2 = input.int(60, title="SMA2")
lenEMA2 = input.int(60, title="EMA2")
lenSMA3 = input.int(120, title="SMA3")
lenEMA3 = input.int(120, title="EMA3")

// === 均线计算 ===
sma1 = ta.sma(close, lenSMA1)
ema1 = ta.ema(close, lenEMA1)
sma2 = ta.sma(close, lenSMA2)
ema2 = ta.ema(close, lenEMA2)
sma3 = ta.sma(close, lenSMA3)
ema3 = ta.ema(close, lenEMA3)

// === 颜色定义 ===
sma1Color = color.rgb(255, 230, 100)  // 浅黄
ema1Color = color.rgb(200, 160, 0)    // 深黄
sma2Color = color.rgb(120, 200, 255)  // 浅蓝
ema2Color = color.rgb(0, 80, 200)     // 深蓝
sma3Color = color.rgb(255, 150, 150)  // 浅红
ema3Color = color.rgb(223, 20, 241)   // 深红

// === 绘制均线 ===
plot(sma1, color=sma1Color, title="SMA1")
plot(ema1, color=ema1Color, title="EMA1")
plot(sma2, color=sma2Color, title="SMA2")
plot(ema2, color=ema2Color, title="EMA2")
plot(sma3, color=sma3Color, title="SMA3")
plot(ema3, color=ema3Color, title="EMA3")


// === 圆点标记 ===
cond = barstate.islast
bl = low
moveBar = input.int(0, title="圆点整体偏移 (Move Bar)")

x1 = input.int(20, title="圆点位置1") + moveBar
x2 = input.int(60, title="圆点位置2") + moveBar
x3 = input.int(120, title="圆点位置3") + moveBar

plot(cond ? bl[lenSMA1] : na, title="标记 SMA1", color=ema1Color, linewidth=5, offset=-x1, style=plot.style_circles)
plot(cond ? bl[lenSMA2] : na, title="标记 SMA2", color=ema2Color, linewidth=5, offset=-x2, style=plot.style_circles)
plot(cond ? bl[lenSMA3] : na, title="标记 SMA3", color=ema3Color, linewidth=5, offset=-x3, style=plot.style_circles)


// === 专业交易策略参数 ===

// 策略快线选择
strategyFast = input.string("EMA1", title="策略快线", options=["EMA1", "SMA1", "EMA2", "SMA2", "EMA3", "SMA3"])
// 策略慢线选择
strategySlow = input.string("EMA2", title="策略慢线", options=["EMA1", "SMA1", "EMA2", "SMA2", "EMA3", "SMA3"])


// 仓位管理参数
initialPositionSize = input.float(0.3, title="初始仓位比例", minval=0.1, maxval=1.0, step=0.1)
addPositionSize = input.float(0.2, title="加仓仓位比例", minval=0.1, maxval=0.5, step=0.1)
maxPositionSize = input.float(1.0, title="最大仓位比例", minval=0.5, maxval=2.0, step=0.1)


// === 根据选择获取对应的均线值 ===
fastMA = strategyFast == "EMA1" ? ema1 : strategyFast == "SMA1" ? sma1 : strategyFast == "EMA2" ? ema2 : strategyFast == "SMA2" ? sma2 : strategyFast == "EMA3" ? ema3 : sma3
slowMA = strategySlow == "EMA1" ? ema1 : strategySlow == "SMA1" ? sma1 : strategySlow == "EMA2" ? ema2 : strategySlow == "SMA2" ? sma2 : strategySlow == "EMA3" ? ema3 : sma3

// === 核心信号识别 ===
// 金叉死叉信号
goldenCross = fastMA > slowMA and fastMA[1] <= slowMA[1]  // 金叉：快线上穿慢线
deathCross = fastMA < slowMA and fastMA[1] >= slowMA[1]   // 死叉：快线下穿慢线

// 趋势判断
trendUp = fastMA > slowMA
trendDown = fastMA < slowMA

// === 专业交易逻辑 ===
// 1. 开仓信号（第一次金叉）
firstEntrySignal = goldenCross and strategy.position_size == 0

// 2. 加仓信号（阳线 + 趋势向上）
// 阳线判断：收盘价高于开盘价
isBullish = close > open

var lastAddPositionBar = 0
// 当前价格相对于快线的偏离量，用于判断回踩
pullbackThreshold = 0.01  // 可调回踩幅度，例如 1%
// 判断回踩未破快线
isPullback = close <= fastMA * (1 + pullbackThreshold) and close >= fastMA
// 加仓条件：阳线 + 趋势向上 + 已有仓位 + 明确回踩快线
pullbackSignal = isBullish and trendUp and strategy.position_size > 0 and isPullback

// 3. 减仓功能已移除

// 4. 平仓信号（死叉或形态破快线）
// 形态破快线判断：价格跌破快线
breakFastLine = close < fastMA

// 连续阴线判断
consecutiveBearish = 0
for i = 0 to 2
    if close[i] < open[i]
        consecutiveBearish += 1

exitSignal = deathCross or (breakFastLine and strategy.position_size > 0)

// 5. 重新入场信号（形态修复）
// 当价格重新回到快线之上时，可以重新入场
reEntrySignal = close > fastMA and strategy.position_size == 0 and trendUp

// === 仓位管理执行 ===
// 开仓
if firstEntrySignal
    strategy.entry("金叉开仓", strategy.long, qty=strategy.equity * initialPositionSize / close, when=barstate.isconfirmed)

// 加仓
if pullbackSignal
    currentPosition = strategy.position_size
    maxAllowedPosition = strategy.equity * maxPositionSize / close
    
    if currentPosition < maxAllowedPosition
        addQty = strategy.equity * addPositionSize / close
        strategy.entry("阳线加仓", strategy.long, qty=addQty, when=barstate.isconfirmed)
        lastAddPositionBar := bar_index  // 记录加仓时间



// 平仓
if exitSignal
    strategy.close_all(when=barstate.isconfirmed, comment="平仓信号")

// 重新入场
if reEntrySignal
    strategy.entry("形态修复入场", strategy.long, qty=strategy.equity * initialPositionSize / close, when=barstate.isconfirmed)

// === 信号标记 ===
// 开仓信号
plotshape(firstEntrySignal, title="开仓信号", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.normal)
// 加仓信号
plotshape(pullbackSignal, title="加仓信号", location=location.belowbar, color=color.blue, style=shape.circle, size=size.small)
// 平仓信号
plotshape(exitSignal, title="平仓信号", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.normal)
// 重新入场信号
plotshape(reEntrySignal, title="重入信号", location=location.belowbar, color=color.lime, style=shape.diamond, size=size.small)

// === 策略信息显示 ===
var table infoTable = table.new(position.top_right, 2, 8, bgcolor=color.white, border_width=1)
if barstate.islast
    table.cell(infoTable, 0, 0, "策略状态", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 0, "专业均线交叉策略", text_color=color.black, bgcolor=color.gray)
    
    table.cell(infoTable, 0, 1, "趋势判断", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 1, trendUp ? "上涨" : "下跌", text_color=color.black, bgcolor=trendUp ? color.green : color.red)
    
    table.cell(infoTable, 0, 2, "交叉信号", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 2, goldenCross ? "金叉" : deathCross ? "死叉" : "等待", text_color=color.black, bgcolor=goldenCross ? color.green : deathCross ? color.red : color.gray)
    
    table.cell(infoTable, 0, 3, "策略快线", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 3, strategyFast, text_color=color.black, bgcolor=color.blue)
    
    table.cell(infoTable, 0, 4, "策略慢线", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 4, strategySlow, text_color=color.black, bgcolor=color.orange)
    
    table.cell(infoTable, 0, 5, "当前仓位", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 5, strategy.position_size > 0 ? "多头" : "空仓", text_color=color.black, bgcolor=strategy.position_size > 0 ? color.green : color.gray)
    
    table.cell(infoTable, 0, 6, "仓位比例", text_color=color.black, bgcolor=color.gray)
    positionRatio = strategy.position_size * close / strategy.equity
    table.cell(infoTable, 1, 6, str.tostring(positionRatio * 100, "#.##") + "%", text_color=color.black, bgcolor=color.blue)
    
    table.cell(infoTable, 0, 7, "形态状态", text_color=color.black, bgcolor=color.gray)
    table.cell(infoTable, 1, 7, close > fastMA ? "形态完好" : "形态破快", text_color=color.black, bgcolor=close > fastMA ? color.green : color.red)
```
## 基础脚本

```js
//@version=5
indicator(title="双均线交易策略", shorttitle="双均线交易策略", overlay=true)
// === 参数输入 ===
lenSMA1 = input.int(20, title="SMA1")
lenEMA1 = input.int(20, title="EMA1")
lenSMA2 = input.int(60, title="SMA2")
lenEMA2 = input.int(60, title="EMA2")
lenSMA3 = input.int(120, title="SMA3")
lenEMA3 = input.int(120, title="EMA3")

// === 均线计算 ===
sma1 = ta.sma(close, lenSMA1)
ema1 = ta.ema(close, lenEMA1)
sma2 = ta.sma(close, lenSMA2)
ema2 = ta.ema(close, lenEMA2)
sma3 = ta.sma(close, lenSMA3)
ema3 = ta.ema(close, lenEMA3)

// === 颜色定义 ===
sma1Color = color.rgb(255, 230, 100)  // 浅黄
ema1Color = color.rgb(200, 160, 0)    // 深黄
sma2Color = color.rgb(120, 200, 255)  // 浅蓝
ema2Color = color.rgb(0, 80, 200)     // 深蓝
sma3Color = color.rgb(255, 150, 150)  // 浅红
ema3Color = color.rgb(223, 20, 241)   // 深红

// === 绘制均线 ===
plot(sma1, color=sma1Color, title="SMA1")
plot(ema1, color=ema1Color, title="EMA1")
plot(sma2, color=sma2Color, title="SMA2")
plot(ema2, color=ema2Color, title="EMA2")
plot(sma3, color=sma3Color, title="SMA3")
plot(ema3, color=ema3Color, title="EMA3")


// === 圆点标记 ===
cond = barstate.islast
bl = low
moveBar = input.int(0, title="圆点整体偏移 (Move Bar)")

x1 = input.int(20, title="圆点位置1") + moveBar
x2 = input.int(60, title="圆点位置2") + moveBar
x3 = input.int(120, title="圆点位置3") + moveBar

plot(cond ? bl[lenSMA1] : na, title="标记 SMA1", color=ema1Color, linewidth=5, offset=-x1, style=plot.style_circles)
plot(cond ? bl[lenSMA2] : na, title="标记 SMA2", color=ema2Color, linewidth=5, offset=-x2, style=plot.style_circles)
plot(cond ? bl[lenSMA3] : na, title="标记 SMA3", color=ema3Color, linewidth=5, offset=-x3, style=plot.style_circles)
```

